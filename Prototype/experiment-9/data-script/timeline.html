<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Timeline</title>
</head>
<body>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<div id="timeline" style="height: 180px;"></div>

<script>
function getIdfromQueryString(queryStr) {
  var query = {};
  var pairs, nameValue, params = {};
  if(!queryStr) {
    return;
  }
  pairs = queryStr.split('&');
  for(var i=0; i<pairs.length; i++) {
    nameValue = pairs[i].split('=');
    if(nameValue[0] && (nameValue[0] === 'id')){
      return nameValue[1];
    }
  }
}

function printUsage() {
    var container = document.getElementById('timeline');
    var p1 = document.createElement('p');
    p1.textContent = 'No lookup.json found, no id querystring given';
    container.appendChild(p1);

    var p2 = document.createElement('p');
    p2.innerHTML = 'Usage: ' +
    '<a href="timeline.html?id=1a">timeline.html?id=1a</a>'
    ' where 1a.json is a file in the ./logs/ directory, produced by running a' +
    ' PDF report from AT&T through scraperJSON.py';
    container.appendChild(p2);
}

function createSeries(data) {
  var incomingSMS = data.incomingSMS.map(function(entry, i) {
    var date = new Date(entry.datetime);
    return ['incomingSMS:'+i, date, 0, 1]; //'incomingSMS'
  });
  var outgoingSMS = data.outgoingSMS.map(function(entry, i) {
    var date = new Date(entry.datetime);
    return ['outgoingSMS:'+i, date, 1, 1]; // 'outgoingSMS'
  });
  var incomingCalls = data.incomingCall.map(function(entry, i) {
    var date = new Date(entry.datetime);
    return ['incomingCall:'+i, date, 2, 1]; // 'incomingSMS'
  });
  var outgoingCalls = data.outgoingCall.map(function(entry, i) {
    var date = new Date(entry.datetime);
    return ['outgoingCall:'+i, date, 3, 1]; // 'outgoingCalls'
  });
  return [].concat(incomingSMS, outgoingSMS, incomingCalls, outgoingCalls);
}

var participantId = getIdfromQueryString(location.search.substring(1));
var chartDataSeries;

if (participantId) {
  window.fetch('./logs/' + participantId + '.json').then(function(resp) {
    resp.json().then(function(data) {
      console.log('loaded data: ', data);
      google.charts.load('current', {'packages':['corechart']});
      // google.charts.load('current', {'packages':['scatter']});
      // google.charts.load('current', {'packages':['timeline']});
      chartDataSeries = createSeries(data);
      google.charts.setOnLoadCallback(function() {
        drawChart(chartDataSeries);
      });
    });
  });
} else {
  window.fetch('./lookup.json').then(function(resp) {
    resp.json().then(function(data) {
      var container = document.getElementById('timeline');
      Object.keys(data).forEach(function(id) {
        var p = document.createElement('p');
        var a = document.createElement('a');
        a.textContent = id;
        a.href = 'timeline.html?id='+id;
        p.appendChild(a);
        container.appendChild(p);
      });
    });
  }).catch(function(e) {
    printUsage();
  });
  var selfLink
  console.log('usage: timeline.html?id=1a');
}

function drawChart(seriesData) {
  console.log('drawChart, seriesData:', seriesData);
  var container = document.getElementById('timeline');
  // var data = new google.visualization.DataTable();
  seriesData.unshift(['ID', 'Date/Time', 'Event', 'Duration']);
  var data = google.visualization.arrayToDataTable(seriesData);
  // data.addColumn('date', 'Date/Time');
  // data.addColumn('string', 'Event');
  // data.addColumn('number', 'Duration');
  // data.addRows(seriesData);

  var options = {
    width: 1200,
    height: 300,
    chart: {
      title: 'Events over Time'
    },
    legend: 'none',
    hAxis: {title: 'Date/Time'},
    vAxis: {title: 'Event'}, // , type: 'string'
    explorer: {},
    bubble: {textStyle: {fontSize: 9}}
  };

  // var chart = new google.charts.Scatter(container);
  // chart.draw(data, google.charts.Scatter.convertOptions(options));
  var chart = new google.visualization.BubbleChart(container);
  chart.draw(data, options);
}

</script>
</body>
</html>
